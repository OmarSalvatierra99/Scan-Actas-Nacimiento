<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Esc√°ner de Actas | OFS Tlaxcala</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <!-- jsQR para decodificar QR en el navegador -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <img src="{{ url_for('static', filename='img/ofs_logo.png') }}" alt="Logo OFS Tlaxcala" class="ofs-logo" />
        <div class="header-text">
          <h1>Esc√°ner de Actas de Nacimiento</h1>
          <p>Sistema oficial de digitalizaci√≥n y registro de actas</p>
        </div>
      </div>
      <div class="header-right">
        <div class="user-info">
          <img src="{{ url_for('static', filename='img/avatar_default.png') }}" alt="Usuario" class="avatar" />
          <div>
            <h2>Gobierno del Estado de Tlaxcala</h2>
            <p>√ìrgano de Fiscalizaci√≥n Superior</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="scan-methods">
      <div class="method-tabs">
        <button class="tab-btn active" data-tab="pdf">üìÑ Subir Acta PDF</button>
        <button class="tab-btn" data-tab="usb">üîå Lector QR USB</button>
        <button class="tab-btn" data-tab="cam">üì∑ C√°mara del navegador</button>
      </div>

      <!-- ===== PDF ===== -->
      <div id="pdf-tab" class="tab-content active">
        <div class="pdf-container">
          <div class="pdf-instructions">
            <h3>Instrucciones para subir acta PDF</h3>
            <ol>
              <li>Seleccione el archivo PDF del acta.</li>
              <li>El sistema detectar√° el QR o extraer√° datos del texto.</li>
              <li>Se registrar√°n todas las actas v√°lidas.</li>
            </ol>
          </div>

          <div class="form-group">
            <input type="file" id="pdfInput" accept=".pdf" class="file-input" style="display: none;">
            <label for="pdfInput" class="btn btn-primary">üìÑ Seleccionar PDF</label>
            <span id="pdfFileName"></span>
          </div>

          <div id="pdfProgress" style="display:none;">
            <div class="message info">
              <p>Procesando PDF...</p>
              <div style="background:#e2e8f0;border-radius:10px;height:10px;margin:10px 0;">
                <div id="pdfProgressBar" style="background:var(--color-primary-light);height:100%;width:0%;border-radius:10px;transition:width 0.3s;"></div>
              </div>
            </div>
          </div>

          <div id="pdfResults"></div>
        </div>
      </div>

      <!-- ===== USB ===== -->
      <div id="usb-tab" class="tab-content">
        <div class="usb-container">
          <div class="usb-instructions">
            <h3>Instrucciones para lector QR USB</h3>
            <ol>
              <li>Conecte el lector QR USB.</li>
              <li>Haga clic en el campo de texto.</li>
              <li>Escanee el QR y presione ENTER.</li>
            </ol>
          </div>

          <div class="form-group">
            <label for="usbInput">Datos del lector USB</label>
            <input type="text" id="usbInput" class="usb-input" placeholder="Haga clic aqu√≠ y escanee..." />
          </div>
          <button id="btnProcessUSB" class="btn btn-primary" disabled>üíæ Guardar Acta</button>
        </div>
      </div>

      <!-- ===== C√ÅMARA ===== -->
      <div id="cam-tab" class="tab-content">
        <div class="cam-container">
          <div class="usb-instructions">
            <h3>Escaneo con c√°mara del navegador</h3>
            <ol>
              <li>Concede permiso a la c√°mara.</li>
              <li>Coloca el QR dentro del recuadro.</li>
              <li>El sistema registrar√° autom√°ticamente al detectar un QR v√°lido.</li>
            </ol>
          </div>

          <div class="cam-preview">
            <video id="camVideo" playsinline muted></video>
            <canvas id="camCanvas" style="display:none;"></canvas>
            <div class="cam-frame"></div>
          </div>

          <div class="cam-controls">
            <button id="btnStartCam" class="btn btn-primary">‚ñ∂ Iniciar c√°mara</button>
            <button id="btnStopCam" class="btn btn-error" disabled>‚ñ† Detener</button>
            <span id="camStatus" class="cam-status">Inactiva</span>
          </div>
        </div>
      </div>
    </section>

    <div id="resultMessage" class="result-message"></div>

    <section class="controls-panel">
      <div class="stats">
        Total de actas escaneadas: <strong id="totalRegistros">{{ total }}</strong>
      </div>
      <div class="actions">
        <a href="{{ url_for('descargar_excel') }}" class="btn btn-download">üì• Descargar Excel</a>
        <button id="btnLimpiar" class="btn btn-error">üóëÔ∏è Limpiar Todo</button>
      </div>
    </section>

    <section class="table-panel">
      <h2>üìã Actas Escaneadas (m√°s recientes primero)</h2>
      <div id="tablaRegistros">{% include '_tabla_registros.html' %}</div>
    </section>
  </main>

  <footer class="footer">
    <p>&copy; {{ current_year }} Gobierno del Estado de Tlaxcala ¬∑ √ìrgano de Fiscalizaci√≥n Superior</p>
  </footer>

  <script>
    // ===== Tabs =====
    document.addEventListener('DOMContentLoaded', () => {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.getAttribute('data-tab');
          tabButtons.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`${tab}-tab`).classList.add('active');
          if (tab === 'usb') setTimeout(() => document.getElementById('usbInput')?.focus(), 200);
        });
      });
    });

    // ===== USB input =====
    const usbInput = document.getElementById('usbInput');
    const btnProcessUSB = document.getElementById('btnProcessUSB');
    if (usbInput) {
      usbInput.addEventListener('input', () => {
        btnProcessUSB.disabled = usbInput.value.trim().length === 0;
      });
      btnProcessUSB.addEventListener('click', async () => {
        const v = usbInput.value.trim();
        if (!v) return;
        await postQR(v);
        usbInput.value = '';
        btnProcessUSB.disabled = true;
        usbInput.focus();
      });
      usbInput.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          btnProcessUSB.click();
        }
      });
    }

    // ===== PDF upload =====
    const pdfInput = document.getElementById('pdfInput');
    const pdfFileName = document.getElementById('pdfFileName');
    const pdfProgress = document.getElementById('pdfProgress');
    const pdfProgressBar = document.getElementById('pdfProgressBar');
    if (pdfInput) {
      pdfInput.addEventListener('change', async () => {
        const f = pdfInput.files?.[0];
        if (!f) return;
        pdfFileName.textContent = f.name;
        pdfProgress.style.display = 'block';
        pdfProgressBar.style.width = '15%';
        const form = new FormData();
        form.append('pdf_file', f);
        const res = await fetch('/procesar_pdf', { method: 'POST', body: form });
        pdfProgressBar.style.width = '60%';
        const data = await res.json();
        pdfProgressBar.style.width = '100%';
        showMessage(data.success, data.message || 'Operaci√≥n completada');
        if (data.tabla_html) refreshTable(data.tabla_html, data.total_registros);
        setTimeout(() => { pdfProgress.style.display = 'none'; pdfProgressBar.style.width = '0%'; }, 600);
      });
    }

    // ===== C√°mara (jsQR) =====
    let stream = null;
    let rafId = null;
    const video = document.getElementById('camVideo');
    const canvas = document.getElementById('camCanvas');
    const ctx = canvas?.getContext('2d');
    const btnStartCam = document.getElementById('btnStartCam');
    const btnStopCam = document.getElementById('btnStopCam');
    const camStatus = document.getElementById('camStatus');
    let scanning = false;
    let lastSent = '';

    async function startCam() {
      if (scanning) return;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = stream;
        await video.play();
        btnStartCam.disabled = true;
        btnStopCam.disabled = false;
        camStatus.textContent = 'Escaneando...';
        scanning = true;
        tick();
      } catch (e) {
        showMessage(false, 'No se pudo acceder a la c√°mara');
      }
    }

    function stopCam() {
      scanning = false;
      if (rafId) cancelAnimationFrame(rafId);
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.pause();
      video.srcObject = null;
      btnStartCam.disabled = false;
      btnStopCam.disabled = true;
      camStatus.textContent = 'Inactiva';
    }

    function tick() {
      if (!scanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = window.jsQR ? jsQR(img.data, img.width, img.height, { inversionAttempts: 'attemptBoth' }) : null;
        if (code && code.data && code.data !== lastSent) {
          lastSent = code.data;
          // Registrar directamente por QR textual
          postQR(code.data).then(() => {
            // pausa corta para evitar duplicados seguidos
            setTimeout(() => { lastSent = ''; }, 1000);
          });
        }
      }
      rafId = requestAnimationFrame(tick);
    }

    btnStartCam?.addEventListener('click', startCam);
    btnStopCam?.addEventListener('click', stopCam);

    // ===== Helpers =====
    async function postQR(qrText) {
      const res = await fetch('/procesar_qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ qr_data: qrText })
      });
      const data = await res.json();
      showMessage(data.success, data.message || (data.success ? 'Registrado' : 'Error'));
      if (data.tabla_html) refreshTable(data.tabla_html, data.total_registros);
      return data;
    }

    function showMessage(ok, msg) {
      const el = document.getElementById('resultMessage');
      el.className = 'message ' + (ok ? 'success' : 'error');
      el.textContent = msg;
      setTimeout(() => { el.className = 'result-message'; el.textContent = ''; }, 5000);
    }

    function refreshTable(html, total) {
      document.getElementById('tablaRegistros').innerHTML = html;
      document.getElementById('totalRegistros').textContent = total;
    }

    // Limpiar todo
    document.getElementById('btnLimpiar')?.addEventListener('click', async () => {
      const res = await fetch('/limpiar_registros', { method: 'POST' });
      const data = await res.json();
      showMessage(data.success, data.message || 'Listo');
      if (data.tabla_html) refreshTable(data.tabla_html, 0);
    });
  </script>

  <!-- Si usas main.js adicional, mantenlo debajo -->
  <!-- <script src="{{ url_for('static', filename='js/main.js') }}"></script> -->
</body>
</html>

